<!-- Version 0.7 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Oracle's Eye - Walk Phase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark gray-blue */
            padding-bottom: 4rem; /* Add padding for footer */
        }
        .screen {
            display: none; /* All screens hidden by default */
        }
        #screen-intention {
            display: block; /* Show the first screen */
        }
        /* Custom styles for a cleaner look */
        .btn {
            @apply inline-block w-full text-center px-6 py-3 rounded-lg font-semibold text-white shadow-md transition-all duration-300;
            @apply focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800;
        }
        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-500;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-500;
        }
        .card-bg {
            @apply bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-xl;
        }
        .input-base {
             @apply w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500;
        }
        textarea.input-base {
            resize: none;
        }
        .radio-label {
            @apply relative block w-full p-4 pl-12 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer hover:bg-gray-600 focus-within:ring-2 focus-within:ring-indigo-500;
            /* Add padding-left for the checkmark */
        }
        input[type="radio"]:checked + .radio-label {
            @apply bg-indigo-700 border-indigo-500 ring-2 ring-indigo-500;
        }
        /* Style for the checkmark */
        input[type="radio"]:checked + .radio-label::before {
             content: '';
             position: absolute;
             left: 0.75rem; /* Adjust position */
             top: 50%;
             transform: translateY(-50%);
             width: 1.25rem; /* Size of checkmark */
             height: 1.25rem;
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='3' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M4.5 12.75l6 6 9-13.5' /%3E%3C/svg%3E");
             background-size: contain;
             background-repeat: no-repeat;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto max-w-lg p-4 min-h-screen flex flex-col justify-center">

        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-white mb-2">The Oracle's Eye</h1>
            <p class="text-lg text-indigo-300">A Guided Tarot Experience</p>
        </header>

        <main class="card-bg" role="main">

            <!-- SCREEN 1: INTENTION -->
            <div id="screen-intention" class="screen" role="region" aria-label="Step 1: Set Intention">
                <h2 class="text-2xl font-semibold text-white mb-4" tabindex="-1">What is your intention?</h2>
                <p class="text-gray-300 mb-4">Select the area of your life that needs clarity. This will focus the reading.</p>

                <fieldset id="intention-options" class="space-y-3">
                    <legend class="sr-only">Intention Options</legend>
                    <div class="relative">
                        <input type="radio" id="intent-general" name="intention" value="General Guidance & Self-Discovery" class="sr-only">
                        <label for="intent-general" class="radio-label">
                            <span class="font-semibold text-white">General Guidance</span>
                            <span class="block text-sm text-gray-300">"What do I need to know right now?"</span>
                        </label>
                    </div>
                    <div class="relative">
                        <input type="radio" id="intent-problem" name="intention" value="Problem Solving & Career" class="sr-only">
                        <label for="intent-problem" class="radio-label">
                            <span class="font-semibold text-white">Problem Solving & Career</span>
                            <span class="block text-sm text-gray-300">"How can I overcome this challenge?"</span>
                        </label>
                    </div>
                    <div class="relative">
                        <input type="radio" id="intent-relationships" name="intention" value="Relationships & Connection" class="sr-only">
                        <label for="intent-relationships" class="radio-label">
                            <span class="font-semibold text-white">Relationships & Connection</span>
                            <span class="block text-sm text-gray-300">"What do I need to understand about this relationship?"</span>
                        </label>
                    </div>
                    <div class="relative">
                        <input type="radio" id="intent-other" name="intention" value="other" class="sr-only">
                        <label for="intent-other" class="radio-label">
                            <span class="font-semibold text-white">Other (Specify)</span>
                        </label>
                    </div>
                </fieldset>

                <textarea id="user-intention-other" rows="3" placeholder="Type your specific question here..." class="input-base mt-3 hidden"></textarea>

                <button id="btn-to-spread" class="btn btn-primary mt-4">Set Intention & Choose Spread</button>
            </div>

            <!-- SCREEN 2: SPREAD CHOICE -->
            <div id="screen-spread-choice" class="screen" role="region" aria-label="Step 2: Choose Spread">
                <h2 class="text-2xl font-semibold text-white mb-4" tabindex="-1">Choose Your Spread</h2>
                <p class="text-gray-300 mb-4">The spread provides the structure for your reading. Select one that fits your question.</p>

                <fieldset id="spread-library" class="space-y-3">
                    <legend class="sr-only">Spread Options</legend>
                    <!-- This will be dynamically populated by SPREAD_LIBRARY -->
                </fieldset>

                <button id="btn-to-upload" class="btn btn-primary mt-4 opacity-50 cursor-not-allowed" disabled>Continue to Upload</button>
                <button id="btn-back-to-intention" class="btn btn-secondary mt-2">Back</button>
            </div>

            <!-- SCREEN 3: UPLOAD & GUIDE -->
            <div id="screen-upload" class="screen" role="region" aria-label="Step 3: Upload Photo">
                <h2 class="text-2xl font-semibold text-white mb-2" tabindex="-1">Lay Out Your Cards</h2>
                <p class="text-gray-300 mb-4">Arrange your physical cards according to the <span id="selected-spread-name" class="font-semibold text-indigo-300">Selected Spread</span>, then upload a single photo.</p>

                <div id="spread-visual-guide" class="mb-6 p-4 bg-gray-700 rounded-lg">
                    <!-- DYNAMIC CONTENT GOES HERE -->
                </div>

                <div class="mb-4">
                    <label for="image-upload" class="block w-full p-6 border-2 border-dashed border-gray-600 rounded-lg text-center cursor-pointer hover:border-indigo-500 hover:bg-gray-700 transition-all focus-within:ring-2 focus-within:ring-indigo-500">
                        <span id="image-upload-text" class="text-gray-300">Click to select an image</span>
                        <input type="file" id="image-upload" class="hidden" accept="image/*">
                    </label>
                </div>

                <div id="image-preview-container" class="mb-4 hidden">
                    <img id="image-preview" src="#" alt="Your uploaded spread" class="max-h-60 w-auto mx-auto rounded-lg shadow-md">
                </div>

                <details classs="mb-4">
                    <summary class="text-sm text-gray-500 cursor-pointer hover:text-white focus:outline-none focus:ring-1 focus:ring-indigo-500">Pro Tips for a Good Reading</summary>
                    <ul class="list-disc list-inside text-sm text-gray-300 mt-2 pl-2">
                        <li>Ensure good, even lighting.</li>
                        <li>Avoid shadows or glare on the cards.</li>
                        <li>Keep the camera parallel to the table.</li>
                        <li>Make sure all cards are fully visible.</li>
                    </ul>
                </details>

                <button id="btn-reveal" class="btn btn-primary mt-6 opacity-50 cursor-not-allowed" disabled>Reveal My Reading</button>
                <button id="btn-back-to-spread" class="btn btn-secondary mt-2">Back</button>
            </div>

            <!-- SCREEN 4: READING -->
            <div id="screen-reading" class="screen" role="region" aria-label="Step 4: Your Reading">
                <h2 class="text-2xl font-semibold text-white mb-4" tabindex="-1">Your Reading</h2>

                <div class="mb-4 flex justify-center" role="group" aria-label="Reading Format">
                    <div classs="bg-gray-700 p-1 rounded-lg flex space-x-1">
                        <button id="toggle-summary" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-pressed="true">Summary</button>
                        <button id="toggle-deep-dive" class="px-4 py-2 text-sm font-semibold text-gray-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-pressed="false">In-Depth</button>
                    </div>
                </div>

                <div id="loading-spinner" class="text-center py-10 hidden" role="status" aria-live="polite">
                    <svg class="animate-spin h-8 w-8 text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-300 mt-3">The Oracle is considering your question...</p>
                </div>

                <div id="error-display" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4" role="alert" aria-live="assertive">
                    <strong class="font-bold">A murky vision!</strong>
                    <span id="error-message" class="block sm:inline"></span>
                </div>

                <div id="results-content" class="hidden" aria-live="polite">
                    <!-- Summary View -->
                    <div id="summary-view" class="">
                        <h3 class="text-xl font-semibold text-indigo-300 mb-2">Your Summary</h3>
                        <p id="summary-text" class="text-gray-300 text-lg leading-relaxed">[Summary of the entire reading will appear here...]</p>
                    </div>
                    <!-- In-Depth View -->
                    <div id="deep-dive-view" class="hidden space-y-4">
                        <h3 class="text-xl font-semibold text-indigo-300 mb-2">Card-by-Card Deep Dive</h3>
                        <div id="deep-dive-cards" class="space-y-4">
                            <!-- DYNAMIC CONTENT GOES HERE -->
                        </div>
                    </div>
                </div>

                <button id="btn-new-reading" class="btn btn-secondary mt-6">Start New Reading</button>
            </div>

        </main>

        <!-- Version Footer -->
        <footer class="text-center text-xs text-gray-500 mt-4">
            Version 0.7
        </footer>
    </div>

    <script>
        // --- SPREAD LIBRARY (From Your Research!) ---
        const SPREAD_LIBRARY = {
            "three-card": {
                id: "three-card",
                name: "Three-Card Spread",
                description: "A quick, versatile spread for clarity on a situation.",
                card_count: 3,
                map: [
                    { position: 1, name: "Past", description: "Past events and influences that led to this situation." },
                    { position: 2, name: "Present", description: "The current situation and energies at play." },
                    { position: 3, name: "Future", description: "The likely outcome if the current path continues." }
                ],
                visual_guide: `
                    <p class="text-sm text-gray-300 mb-4">Lay your 3 cards in a horizontal line:</p>
                    <div class="flex justify-around text-center">
                        <div class="w-1/3 p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">1</span>
                            <span class="block text-sm text-indigo-300">Past</span>
                        </div>
                        <div class="w-1/3 p-2 border border-gray-600 rounded-lg mx-2">
                            <span class="block font-bold text-white">2</span>
                            <span class="block text-sm text-indigo-300">Present</span>
                        </div>
                        <div class="w-1/3 p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">3</span>
                            <span class="block text-sm text-indigo-300">Future</span>
                        </div>
                    </div>
                `
            },
            "celtic-cross": {
                id: "celtic-cross",
                name: "10-Card Celtic Cross",
                description: "A deep, comprehensive analysis of a complex situation.",
                card_count: 10,
                map: [
                    { position: 1, name: "The Present / The Self", description: "The heart of the matter; your current state of mind." },
                    { position: 2, name: "The Challenge", description: "The immediate obstacle or supporting influence." },
                    { position: 3, name: "The Foundation / The Past", description: "The root cause or past events forming the foundation." },
                    { position: 4, name: "The Recent Past", description: "Events that are just passing or energies that linger." },
                    { position: 5, name: "The Potential / The Crown", description: "The best possible outcome or conscious goals." },
                    { position: 6, name: "The Near Future", description: "What is likely to happen in the immediate future." },
                    { position: 7, name: "Your Influence / The Self", description: "Your attitude or self-perception in this matter." },
                    { position: 8, name: "External Influences", description: "The people, places, or external energies affecting you." },
                    { position: 9, name: "Hopes and Fears", description: "Your subconscious desires and anxieties." },
                    { position: 10, name: "The Outcome", description: "The likely resolution if the current path is followed." }
                ],
                visual_guide: `
                    <p class="text-sm text-gray-300 mb-4">Lay your 10 cards in the Celtic Cross pattern:</p>
                    <div class="grid grid-cols-4 gap-2 text-center text-xs">
                        <!-- Staff (Right Side) -->
                        <div></div> <div></div>
                        <div class ="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">10</span>
                            <span class="block text-indigo-300">Outcome</span>
                        </div>
                        <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">7</span>
                            <span class="block text-indigo-300">Self</span>
                        </div>

                        <div class="p-2 border border-gray-600 rounded-lg">
                            <span class ="block font-bold text-white">5</span>
                            <span class="block text-indigo-300">Potential</span>
                        </div>
                        <div class="p-2 border border-gray-600 rounded-lg row-span-2 relative">
                            <span class="block font-bold text-white">1</span>
                            <span class="block text-indigo-300">Present</span>
                            <div class="absolute top-1/2 left-1/4 w-1/2 p-2 border-2 border-dashed border-indigo-400 rounded-lg" style="transform: translateY(-50%) rotate(90deg);">
                                <span class="block font-bold text-white">2</span>
                                <span class="block text-indigo-300">Challenge</span>
                            </div>
                        </div>
                         <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">9</span>
                            <span class="block text-indigo-300">Hopes/Fears</span>
                        </div>
                         <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">8</span>
                            <span class="block text-indigo-300">External</span>
                        </div>

                        <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">4</span>
                            <span class="block text-indigo-300">Recent Past</span>
                        </div>
                         <div></div> <div></div>
                         <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">6</span>
                            <span class="block text-indigo-300">Near Future</span>
                        </div>

                         <div></div>
                        <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">3</span>
                            <span class="block text-indigo-300">Foundation</span>
                        </div>
                        <div></div> <div></div>
                    </div>
                `
            }
        };

        // --- STATE MANAGEMENT ---
        const appState = {
            currentScreen: 'screen-intention',
            userIntention: '',
            selectedSpread: null,
            uploadedImage: null,
            reading: null
        };

        // --- DOM ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const imageUpload = document.getElementById('image-upload');
        const imageUploadText = document.getElementById('image-upload-text');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const revealButton = document.getElementById('btn-reveal');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');
        const resultsContent = document.getElementById('results-content');
        const summaryView = document.getElementById('summary-view');
        const summaryText = document.getElementById('summary-text');
        const deepDiveView = document.getElementById('deep-dive-view');
        const deepDiveCards = document.getElementById('deep-dive-cards');
        const spreadLibraryContainer = document.getElementById('spread-library');
        const visualGuideContainer = document.getElementById('spread-visual-guide');
        const selectedSpreadName = document.getElementById('selected-spread-name');

        // --- NAVIGATION ---
        const btnToIntention = document.getElementById('btn-back-to-intention');
        const btnToSpread = document.getElementById('btn-to-spread');
        const btnToUpload = document.getElementById('btn-to-upload');
        const btnToSpreadBack = document.getElementById('btn-back-to-spread');
        const btnNewReading = document.getElementById('btn-new-reading');
        const toggleSummary = document.getElementById('toggle-summary');
        const toggleDeepDive = document.getElementById('toggle-deep-dive');

        // --- INTENTION SCREEN ---
        const intentionOptions = document.querySelectorAll('input[name="intention"]');
        const userIntentionOther = document.getElementById('user-intention-other');

        intentionOptions.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'other') {
                    userIntentionOther.classList.remove('hidden');
                    userIntentionOther.focus();
                } else {
                    userIntentionOther.classList.add('hidden');
                }
            });
        });

        // --- FIX V0.5: More Robust Label Click Handler (Keep this fix) ---
        document.querySelectorAll('#intention-options .radio-label').forEach(label => {
            label.addEventListener('click', (e) => {
                const radioId = label.getAttribute('for');
                const radio = document.getElementById(radioId);
                if (radio && !radio.checked) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        });

        /**
         * Core navigation function.
         */
        function showScreen(screenId) {
            screens.forEach(screen => screen.style.display = 'none');
            const newScreen = document.getElementById(screenId);
            newScreen.style.display = 'block';
            appState.currentScreen = screenId;
            window.scrollTo(0, 0);

            const heading = newScreen.querySelector('h2');
            if(heading) {
                heading.setAttribute('tabindex', -1);
                heading.focus();
            }
        }

        // --- NAVIGATION EVENT LISTENERS ---

        // Screen 1 -> Screen 2
        btnToSpread.addEventListener('click', () => {
            const selectedIntention = document.querySelector('input[name="intention"]:checked');
            if (!selectedIntention) {
                alert('Please select an intention to proceed.');
                return;
            }

            if (selectedIntention.value === 'other') {
                const otherText = userIntentionOther.value.trim();
                if (otherText.length < 5) {
                    alert('Please enter your specific question.');
                    return;
                }
                appState.userIntention = otherText;
            } else {
                appState.userIntention = selectedIntention.value;
            }

            populateSpreadLibrary();
            showScreen('screen-spread-choice');
        });

        // Screen 2 -> Screen 1 (Back)
        btnToIntention.addEventListener('click', () => showScreen('screen-intention'));

        // Screen 2 -> Screen 3
        btnToUpload.addEventListener('click', () => {
            if (!appState.selectedSpread) {
                alert('Please select a spread.');
                return;
            }
            selectedSpreadName.textContent = appState.selectedSpread.name;
            visualGuideContainer.innerHTML = appState.selectedSpread.visual_guide;
            showScreen('screen-upload');
        });

        // Screen 3 -> Screen 2 (Back)
        btnToSpreadBack.addEventListener('click', () => showScreen('screen-spread-choice'));

        // Screen 4 -> Screen 1 (New Reading)
        btnNewReading.addEventListener('click', () => {
             // Reset state
            appState.userIntention = '';
            appState.selectedSpread = null;
            appState.uploadedImage = null;
            appState.reading = null;

            // Reset Intention Screen
            const checkedIntention = document.querySelector('input[name="intention"]:checked');
            if (checkedIntention) checkedIntention.checked = false;
             intentionOptions.forEach(radio => {
                 const label = document.querySelector(`label[for="${radio.id}"]`);
                 if(label) { // Reset visual style
                     label.classList.remove('bg-indigo-700', 'border-indigo-500', 'ring-2', 'ring-indigo-500');
                     label.classList.add('bg-gray-700', 'border-gray-600');
                 }
            });
            userIntentionOther.value = '';
            userIntentionOther.classList.add('hidden');

             // Reset Spread Screen (Disable button)
             btnToUpload.classList.add('opacity-50', 'cursor-not-allowed');
             btnToUpload.disabled = true;
             // We'll repopulate spreads when screen is shown, but ensure no visual selection remains
             // (This should be handled by CSS :checked, but added JS clear for paranoia)
             const checkedSpread = document.querySelector('input[name="spread"]:checked');
             if(checkedSpread) checkedSpread.checked = false;


            // Reset Upload Screen
            imageUpload.value = null;
            imagePreview.src = '#';
            imagePreviewContainer.classList.add('hidden');
            imageUploadText.textContent = "Click to select an image";
            revealButton.classList.add('opacity-50', 'cursor-not-allowed');
            revealButton.disabled = true;

            // Reset Reading Screen
            resultsContent.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            summaryText.textContent = '';
            deepDiveCards.innerHTML = '';
            // Reset toggle buttons to default (Summary active)
            toggleSummary.click(); // Programmatically click summary

            // Navigate
            showScreen('screen-intention');
        });


        // --- SPREAD SELECTION ---

        function populateSpreadLibrary() {
            spreadLibraryContainer.innerHTML = ''; // Clear old
            Object.values(SPREAD_LIBRARY).forEach(spread => {
                const isChecked = appState.selectedSpread && appState.selectedSpread.id === spread.id; // Preserve selection if going back/forth
                const spreadHtml = `
                    <div class="relative">
                        <input type="radio" id="${spread.id}" name="spread" value="${spread.id}" class="sr-only" ${isChecked ? 'checked' : ''}>
                        <label for="${spread.id}" class="radio-label">
                            <span class="font-semibold text-white text-lg">${spread.name}</span>
                            <span class="block text-sm text-gray-300">${spread.description}</span>
                        </label>
                    </div>
                `;
                spreadLibraryContainer.innerHTML += spreadHtml;
            });

            // --- FIX V0.5: More Robust Label Click Handler (Keep this fix) ---
             document.querySelectorAll('#spread-library .radio-label').forEach(label => {
                label.addEventListener('click', (e) => {
                    const radioId = label.getAttribute('for');
                    const radio = document.getElementById(radioId);
                    if (radio && !radio.checked) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
            });

            document.querySelectorAll('input[name="spread"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectSpread(e.target.value);
                });
            });

            // Re-enable button if a spread was already selected
            if(appState.selectedSpread) {
                 btnToUpload.classList.remove('opacity-50', 'cursor-not-allowed');
                 btnToUpload.disabled = false;
            } else {
                 btnToUpload.classList.add('opacity-50', 'cursor-not-allowed');
                 btnToUpload.disabled = true;
            }
        }

        function selectSpread(spreadId) {
            appState.selectedSpread = SPREAD_LIBRARY[spreadId];
            btnToUpload.classList.remove('opacity-50', 'cursor-not-allowed');
            btnToUpload.disabled = false;
        }

        // --- IMAGE HANDLING ---
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    // Store only the base64 part
                    const base64String = e.target.result.split(',')[1];
                     if (!base64String) {
                         console.error("Failed to extract base64 data from image.");
                         displayError("Could not process the selected image. Please try a different one.");
                         appState.uploadedImage = null;
                         revealButton.classList.add('opacity-50', 'cursor-not-allowed');
                         revealButton.disabled = true;
                         return;
                     }
                    appState.uploadedImage = base64String;
                    revealButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    revealButton.disabled = false;
                    imageUploadText.textContent = file.name;
                };
                 reader.onerror = (error) => {
                     console.error("FileReader error:", error);
                     displayError("Could not read the selected image file. Please try again.");
                     appState.uploadedImage = null;
                     revealButton.classList.add('opacity-50', 'cursor-not-allowed');
                     revealButton.disabled = true;
                 };
                reader.readAsDataURL(file);
            } else {
                // Handle case where user cancels file selection
                appState.uploadedImage = null;
                revealButton.classList.add('opacity-50', 'cursor-not-allowed');
                revealButton.disabled = true;
                imagePreviewContainer.classList.add('hidden');
                imageUploadText.textContent = "Click to select an image";
            }
        });


        // --- READING TOGGLE (SUMMARY/DEEP DIVE) ---
        toggleSummary.addEventListener('click', () => {
            summaryView.style.display = 'block';
            deepDiveView.style.display = 'none';
            toggleSummary.setAttribute('aria-pressed', 'true');
            toggleSummary.classList.add('bg-indigo-600', 'text-white');
            toggleSummary.classList.remove('text-gray-300');

            toggleDeepDive.setAttribute('aria-pressed', 'false');
            toggleDeepDive.classList.add('text-gray-300');
            toggleDeepDive.classList.remove('bg-indigo-600', 'text-white');
        });

        toggleDeepDive.addEventListener('click', () => {
            summaryView.style.display = 'none';
            deepDiveView.style.display = 'block';
            toggleDeepDive.setAttribute('aria-pressed', 'true');
            toggleDeepDive.classList.add('bg-indigo-600', 'text-white');
            toggleDeepDive.classList.remove('text-gray-300');

            toggleSummary.setAttribute('aria-pressed', 'false');
            toggleSummary.classList.add('text-gray-300');
            toggleSummary.classList.remove('bg-indigo-600', 'text-white');
        });

        // --- AI API CALL ---
        revealButton.addEventListener('click', () => {
            if (!appState.uploadedImage) {
                displayError('Please upload an image first.');
                return;
            }
            performReading();
        });

        async function performReading() {
            console.log("Starting performReading..."); // DEBUG V0.6
            showScreen('screen-reading');
            loadingSpinner.style.display = 'block';
            resultsContent.style.display = 'none';
            errorDisplay.style.display = 'none';

            const userIntention = appState.userIntention;
            const spreadName = appState.selectedSpread ? appState.selectedSpread.name : 'Unknown Spread'; // DEBUG V0.6 Add fallback
            const spreadMapString = appState.selectedSpread ? appState.selectedSpread.map
                .map(p => `Position ${p.position} (${p.name}): ${p.description}`)
                .join('\n') : 'No spread map available.'; // DEBUG V0.6 Add fallback

             // DEBUG V0.6 Check if selectedSpread is valid
             if (!appState.selectedSpread || !appState.selectedSpread.map || !Array.isArray(appState.selectedSpread.map)) {
                 console.error("performReading Error: appState.selectedSpread is invalid", appState.selectedSpread);
                 displayError('Error: Invalid spread selected. Please go back and choose a spread.');
                 loadingSpinner.style.display = 'none'; // Hide spinner on early exit
                 return;
             }

            const prompt = `
                You are The Oracle, a wise and insightful Tarot reader.
                A user has provided an image of a tarot spread, a question, and the spread's structure.

                USER'S QUESTION/INTENTION: "${userIntention}"
                SPREAD: "${spreadName}"
                SPREAD MAP:
                ${spreadMapString}

                Analyze the provided image of their tarot spread.
                Your task is to identify exactly ${appState.selectedSpread.card_count} cards, their orientations (Upright, Reversed, or Sideways), and their positions in the spread.
                Match the card's physical position in the image to its corresponding position in the SPREAD MAP.

                Synthesize ALL this information (the question, the spread map, and the cards) into a cohesive, narrative reading.

                Respond ONLY with a valid JSON object with two keys: "summary" and "deep_dive".

                1.  "summary": A single, insightful paragraph (3-5 sentences) that provides the main message of the reading, directly answering the user's question.
                2.  "deep_dive": An array of objects, one for each position in the spread. Each object must have "position_number", "position_name", "card_name", "orientation", and "meaning".

                "meaning" MUST be a detailed interpretation of that specific card in that specific position, synthesized with the user's question.

                If you detect a card is "Sideways", interpret it as "blocked or delayed energy" related to that card's meaning.

                Example for deep_dive array:
                [
                    { "position_number": 1, "position_name": "The Present / The Self", "card_name": "The Fool", "orientation": "Upright", "meaning": "In the context of your career, this represents a new beginning. You are at the start of a new journey..." },
                    { "position_number": 2, "position_name": "The Challenge", "card_name": "The Tower", "orientation": "Reversed", "meaning": "Your main challenge is an avoidance of a necessary change. You are resisting a "Tower" moment..." }
                ]
            `;

            // --- DEBUG V0.6: Add specific logging and ensure finally always runs ---
            try {
                // --- SIMULATED RESPONSE (FOR OFFLINE DEVELOPMENT) ---
                console.log("Simulating API call..."); // DEBUG V0.6
                await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate async delay

                // Ensure selectedSpread and map are valid before simulation
                 if (!appState.selectedSpread || !appState.selectedSpread.map || !Array.isArray(appState.selectedSpread.map)) {
                     throw new Error("Cannot generate simulation: selectedSpread.map is invalid.");
                 }

                const simulatedResponse = {
                    summary: `Simulated summary for your question about "${appState.userIntention}". This reading suggests potential opportunities and challenges related to your focus. Pay attention to the energies of change and intuition.`,
                    deep_dive: appState.selectedSpread.map.map((position, index) => {
                        // Keep simulation simple and predictable
                        const cards = ["The Fool", "The Tower", "The High Priestess", "The Magician", "The Lovers", "The Chariot", "Strength", "The Hermit", "Wheel of Fortune", "Justice"];
                        const orientations = ["Upright", "Reversed", "Sideways"];
                        const card = cards[index % cards.length];
                        const orientation = orientations[index % orientations.length];
                         // Ensure all required fields are present
                        return {
                            position_number: position.position,
                            position_name: position.name || "Unknown Position",
                            card_name: card,
                            orientation: orientation,
                            meaning: `This is a simulated interpretation for ${card} (${orientation}) in the '${position.name || 'Unknown Position'}' position, relating to your question about "${appState.userIntention}". It represents the card's energy in this context.`
                        };
                    })
                };

                 console.log("Simulation complete. Generated response:", simulatedResponse); // DEBUG V0.6
                appState.reading = simulatedResponse;
                displayReading(); // Changed: Pass no argument, let it read from appState

            } catch (simError) {
                 console.error('Error during simulation generation or displayReading call:', simError); // DEBUG V0.6 More specific log
                 displayError(`An unexpected error occurred during the simulation: ${simError.message}`);
            } finally {
                 console.log("Hiding spinner in finally block."); // DEBUG V0.6
                 loadingSpinner.style.display = 'none'; // Ensure spinner hides
            }


            // --- REAL API CALL (COMMENTED OUT FOR NOW) ---
            /*
            try {
                console.log("Attempting REAL API call..."); // DEBUG V0.6
                const apiKey = ""; // Will be auto-provided
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: appState.uploadedImage } }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };
                console.log("Sending payload to API:", payload); // DEBUG V0.6

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log("API response status:", response.status); // DEBUG V0.6

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response Body:", errorBody); // DEBUG V0.6
                    throw new Error(`API Error: ${response.status} ${response.statusText}. Body: ${errorBody}`);
                }

                const result = await response.json();
                console.log("API Result:", result); // DEBUG V0.6

                if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0] || !result.candidates[0].content.parts[0].text) {
                     console.error("Malformed API response structure:", result); // DEBUG V0.6
                     throw new Error("The Oracle's response was empty or malformed.");
                }

                const jsonString = result.candidates[0].content.parts[0].text;
                console.log("Received JSON string from API:", jsonString); // DEBUG V0.6

                try {
                    const reading = JSON.parse(jsonString);
                     console.log("Parsed reading:", reading); // DEBUG V0.6
                    appState.reading = reading;
                    displayReading(); // Changed: Pass no argument
                } catch (jsonError) {
                    console.error('JSON Parse Error:', jsonError, "Raw string:", jsonString); // DEBUG V0.6
                    throw new Error(`The Oracle's response was in a strange format. Could not parse JSON.`);
                }

            } catch (error) {
                console.error('Error in performReading (REAL API CALL):', error); // DEBUG V0.6
                displayError(`The Oracle's vision is clouded. ${error.message}. Please try again with a clearer photo or check the console for details.`);
            } finally {
                 console.log("Hiding spinner in finally block (REAL API)."); // DEBUG V0.6
                loadingSpinner.style.display = 'none'; // Ensure spinner hides
            }
            */
            // --- END OF REAL API CALL ---
        }

        /**
         * Renders the AI's response in the UI.
         */
        function displayReading() {
            // --- DEBUG V0.6: Add specific logging here ---
            console.log("Attempting to display reading. Current appState.reading:", appState.reading);
            try {
                // Ensure reading is accessed from the global state reliably
                const reading = appState.reading;
                if (!reading || typeof reading !== 'object') {
                    console.error("displayReading Error: appState.reading is null or not an object.", reading);
                    displayError("Error: No valid reading data found in application state.");
                    return;
                }
                if (!reading.summary || typeof reading.summary !== 'string') {
                    console.error("displayReading Error: reading.summary is missing or invalid.", reading.summary);
                    displayError("The Oracle's summary response was incomplete.");
                    return;
                }
                 if (!reading.deep_dive || !Array.isArray(reading.deep_dive)) {
                     console.error("displayReading Error: reading.deep_dive is missing or not an array.", reading.deep_dive);
                    displayError("The Oracle's detailed response was incomplete or malformed.");
                    return;
                 }


                // Populate Summary
                summaryText.textContent = reading.summary;

                // Populate Deep Dive
                deepDiveCards.innerHTML = ''; // Clear old results

                 // Check if deep_dive array is empty
                 if (reading.deep_dive.length === 0) {
                     console.warn("displayReading: deep_dive array is empty.");
                     // Optionally display a message, or just show nothing in deep dive
                      deepDiveCards.innerHTML = '<p class="text-gray-400 italic">No detailed card interpretations were provided.</p>';
                 } else {
                    reading.deep_dive.forEach((card, index) => {
                         // Add more defensive checks for card properties
                        const cardName = card && card.card_name ? card.card_name : "Unknown Card";
                        const orientation = card && card.orientation ? card.orientation : "N/A";
                        const positionNum = card && card.position_number ? card.position_number : (index + 1); // Fallback
                        const positionName = card && card.position_name ? card.position_name : "Unknown Position";
                        const meaning = card && card.meaning ? card.meaning : "No interpretation provided.";

                        const cardHtml = `
                            <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                                <div class="flex items-start">
                                    <span class="flex-shrink-0 flex items-center justify-center h-10 w-10 rounded-full bg-indigo-600 text-white font-bold text-lg mr-4">${positionNum}</span>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">${positionName}</h3>
                                        <p class="text-md font-medium text-indigo-300">${cardName} (${orientation})</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-300 mt-3 pl-14">${meaning}</p>
                            </div>
                        `;
                        deepDiveCards.innerHTML += cardHtml;
                    });
                 }


                resultsContent.style.display = 'block';
                errorDisplay.style.display = 'none'; // Ensure error is hidden on success
                toggleSummary.click(); // Default to summary view

            } catch (error) {
                console.error('Error during displayReading render:', error); // DEBUG V0.6 More specific log
                displayError(`There was a problem displaying the reading results: ${error.message}`);
                resultsContent.style.display = 'none'; // Hide potentially broken results
            }
        }


        /**
         * Shows a user-friendly error message.
         */
        function displayError(message) {
             console.error("Displaying Error:", message); // DEBUG V0.6 Log errors shown to user
            errorMessage.textContent = message;
            errorDisplay.style.display = 'block';
            loadingSpinner.style.display = 'none'; // Ensure spinner is hidden on error
            resultsContent.style.display = 'none'; // Hide results area on error
        }

        // --- INITIALIZE APP ---
        populateSpreadLibrary();

    </script>
</body>
</html>

