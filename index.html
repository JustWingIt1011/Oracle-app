<!-- Version 2.4 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Oracle's Eye - Walk Phase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark gray-blue */
            padding-bottom: 4rem; /* Ensure space for footer */
        }
        .screen {
            display: none; /* All screens hidden by default */
        }
        #screen-intention {
            display: block; /* Show the first screen */
        }
        /* V2.4: Ensure base button styles apply broadly */
        .btn {
            @apply inline-block w-full text-center px-6 py-3 rounded-lg font-semibold shadow-md transition-all duration-300 border; /* Added base border */
            @apply focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-500 focus:ring-indigo-500;
        }
        /* V2.4: Explicit styling for secondary buttons */
        .btn-secondary {
            @apply bg-transparent text-gray-300 border-gray-500 hover:bg-gray-700 hover:border-indigo-500 hover:text-white focus:ring-indigo-500 shadow-none;
             /* Ensure padding and block behavior inherited */
        }
        /* Style for disabled primary button */
        .btn-primary:disabled {
            @apply bg-indigo-800 border-indigo-800 text-gray-400 opacity-60 cursor-not-allowed; /* Adjusted opacity/text color */
        }
        .card-bg {
            @apply bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-xl;
        }
        .input-base {
             @apply w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500;
        }
        textarea.input-base {
            resize: none;
        }
        /* Radio Button Style */
        .radio-label {
            /* V2.4: Use inline-flex for direct alignment */
            @apply inline-flex items-center w-full p-4 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer text-center transition-colors duration-200 hover:bg-gray-600 focus-within:ring-2 focus-within:ring-indigo-500;
        }
        /* Style for the selection icon */
        .selection-icon {
             @apply hidden mr-3 text-white flex-shrink-0; /* Keep margin */
             /* Size is set directly on the SVG element */
        }
        /* Apply selected styles when checked */
        input[type="radio"]:checked + .radio-label {
            @apply bg-indigo-600 border-indigo-400 border-2 text-white ring-2 ring-indigo-400;
        }
         /* JS will handle showing the icon */
         input[type="radio"]:checked + .radio-label span,
         input[type="radio"]:checked + .radio-label .label-subtext {
             @apply text-white;
         }
         /* Container for text next to icon */
         .label-text-container {
             @apply text-left flex-grow;
         }
         .label-subtext {
            @apply block text-sm text-gray-300;
         }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto max-w-lg p-4 min-h-screen flex flex-col justify-center">

        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-white mb-2">The Oracle's Eye</h1>
            <p class="text-lg text-indigo-300">A Guided Tarot Experience</p>
        </header>

        <main class="card-bg" role="main">

            <!-- SCREEN 1: INTENTION -->
            <div id="screen-intention" class="screen" role="region" aria-label="Step 1: Set Intention">
                <h2 class="text-2xl font-semibold text-white mb-4" tabindex="-1">What is your intention?</h2>
                <p class="text-gray-300 mb-4">Select the area of your life that needs clarity. This will focus the reading.</p>

                <fieldset id="intention-options" class="space-y-3">
                    <legend class="sr-only">Intention Options</legend>
                    <div class="relative">
                        <input type="radio" id="intent-general" name="intention" value="General Guidance & Self-Discovery" class="sr-only">
                        <label for="intent-general" class="radio-label" onclick="handleIntentionSelection('intent-general')">
                            <svg class="selection-icon" width="12" height="12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            <div class="label-text-container">
                                <span class="font-semibold">General Guidance</span>
                                <span class="label-subtext">"What do I need to know right now?"</span>
                            </div>
                        </label>
                    </div>
                    <div class="relative">
                        <input type="radio" id="intent-problem" name="intention" value="Problem Solving & Career" class="sr-only">
                        <label for="intent-problem" class="radio-label" onclick="handleIntentionSelection('intent-problem')">
                            <svg class="selection-icon" width="12" height="12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            <div class="label-text-container">
                                <span class="font-semibold">Problem Solving & Career</span>
                                <span class="label-subtext">"How can I overcome this challenge?"</span>
                            </div>
                        </label>
                    </div>
                    <div class="relative">
                        <input type="radio" id="intent-relationships" name="intention" value="Relationships & Connection" class="sr-only">
                        <label for="intent-relationships" class="radio-label" onclick="handleIntentionSelection('intent-relationships')">
                            <svg class="selection-icon" width="12" height="12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                           <div class="label-text-container">
                                <span class="font-semibold">Relationships & Connection</span>
                                <span class="label-subtext">"What do I need to understand about this relationship?"</span>
                            </div>
                        </label>
                    </div>
                    <div class="relative">
                        <input type="radio" id="intent-other" name="intention" value="other" class="sr-only">
                        <label for="intent-other" class="radio-label" onclick="handleIntentionSelection('intent-other')">
                            <svg class="selection-icon" width="12" height="12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                           <div class="label-text-container">
                                <span class="font-semibold">Other (Specify)</span>
                            </div>
                        </label>
                    </div>
                </fieldset>

                <textarea id="user-intention-other" rows="3" placeholder="Type your specific question here..." class="input-base mt-3 hidden"></textarea>

                <button id="btn-to-spread" class="btn btn-primary mt-4" disabled>Set Intention</button>
            </div>

            <!-- SCREEN 2: SPREAD CHOICE -->
            <div id="screen-spread-choice" class="screen" role="region" aria-label="Step 2: Choose Spread">
                <h2 class="text-2xl font-semibold text-white mb-4" tabindex="-1">Choose Your Spread</h2>
                <p class="text-gray-300 mb-4">The spread provides the structure for your reading. Select one that fits your question.</p>

                <fieldset id="spread-library" class="space-y-3">
                    <legend class="sr-only">Spread Options</legend>
                    <!-- Dynamically populated -->
                </fieldset>

                <button id="btn-to-upload" class="btn btn-primary mt-4" disabled>Continue to Upload</button>
                <button id="btn-back-to-intention" class="btn btn-secondary mt-2">Back</button>
            </div>

            <!-- SCREEN 3: UPLOAD & GUIDE -->
            <div id="screen-upload" class="screen" role="region" aria-label="Step 3: Upload Photo">
                <h2 class="text-2xl font-semibold text-white mb-2" tabindex="-1">Lay Out Your Cards</h2>
                <p class="text-gray-300 mb-4">Arrange your physical cards according to the <span id="selected-spread-name" class="font-semibold text-indigo-300">Selected Spread</span>, then upload a single photo.</p>

                <div id="spread-visual-guide" class="mb-6 p-4 bg-gray-700 rounded-lg">
                    <!-- DYNAMIC CONTENT -->
                </div>

                <div class="mb-4">
                    <label for="image-upload" class="block w-full p-6 border-2 border-dashed border-gray-600 rounded-lg text-center cursor-pointer hover:border-indigo-500 hover:bg-gray-700 transition-all focus-within:ring-2 focus-within:ring-indigo-500">
                        <span id="image-upload-text" class="text-gray-300">Click to select an image</span>
                        <input type="file" id="image-upload" class="hidden" accept="image/*">
                    </label>
                </div>

                <div id="image-preview-container" class="mb-4 hidden">
                    <img id="image-preview" src="#" alt="Your uploaded spread" class="max-h-60 w-auto mx-auto rounded-lg shadow-md">
                </div>

                <details class="mb-4">
                    <summary class="text-sm text-gray-500 cursor-pointer hover:text-white focus:outline-none focus:ring-1 focus:ring-indigo-500">Pro Tips for a Good Reading</summary>
                    <ul class="list-disc list-inside text-sm text-gray-300 mt-2 pl-2">
                        <li>Ensure good, even lighting.</li>
                        <li>Avoid shadows or glare on the cards.</li>
                        <li>Keep the camera parallel to the table.</li>
                        <li>Make sure all cards are fully visible.</li>
                        <li><strong class="text-indigo-300">Avoid significant overlap</strong> that hides key card details (the AI is smart, but needs to see the symbols!).</li>
                    </ul>
                </details>

                <button id="btn-reveal" class="btn btn-primary mt-6" disabled>Reveal My Reading</button>
                <button id="btn-back-to-spread" class="btn btn-secondary mt-2">Back</button>
            </div>

            <!-- SCREEN 4: READING -->
            <div id="screen-reading" class="screen" role="region" aria-label="Step 4: Your Reading">
                <h2 class="text-2xl font-semibold text-white mb-4" tabindex="-1">Your Reading</h2>

                <div class="mb-4 flex justify-center" role="group" aria-label="Reading Format">
                    <div class="bg-gray-700 p-1 rounded-lg flex space-x-1">
                        <button id="toggle-summary" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-pressed="true">Summary</button>
                        <button id="toggle-deep-dive" class="px-4 py-2 text-sm font-semibold text-gray-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-pressed="false">In-Depth</button>
                    </div>
                </div>

                <div id="loading-spinner" class="text-center py-10 hidden" role="status" aria-live="polite">
                    <svg class="animate-spin h-8 w-8 text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-300 mt-3">The Oracle is considering your question...</p>
                </div>

                <div id="error-display" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4" role="alert" aria-live="assertive">
                    <strong class="font-bold">A murky vision!</strong>
                    <span id="error-message" class="block sm:inline"></span>
                </div>

                <div id="results-content" class="hidden" aria-live="polite">
                    <!-- Summary View -->
                    <div id="summary-view" class="">
                        <h3 class="text-xl font-semibold text-indigo-300 mb-2">Your Summary</h3>
                        <p id="summary-text" class="text-gray-300 text-lg leading-relaxed">[Summary]</p>
                    </div>
                    <!-- In-Depth View -->
                    <div id="deep-dive-view" class="hidden space-y-4">
                        <h3 class="text-xl font-semibold text-indigo-300 mb-2">Spread Context</h3>
                        <div id="deep-dive-spread-guide" class="mb-6 p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                           <!-- DYNAMIC CONTENT -->
                        </div>
                        <h3 class="text-xl font-semibold text-indigo-300 mb-2">Card-by-Card Deep Dive</h3>
                        <div id="deep-dive-cards" class="space-y-4">
                            <!-- DYNAMIC CONTENT -->
                        </div>
                    </div>
                </div>

                <button id="btn-new-reading" class="btn btn-secondary mt-6">Start New Reading</button>
            </div>

        </main>

        <footer class="text-center text-xs text-gray-500 mt-4">
            Version 2.4
        </footer>
    </div>

    <script>
        // --- SPREAD LIBRARY ---
        const SPREAD_LIBRARY = {
            "three-card": { id: "three-card", name: "Three-Card Spread", description: "A quick, versatile spread.", card_count: 3, map: [{ position: 1, name: "Past", description: "Past events influencing the situation." }, { position: 2, name: "Present", description: "The current situation and energies." }, { position: 3, name: "Future", description: "The likely outcome or path forward." }], visual_guide: `<p class="text-sm text-gray-300 mb-4">Lay 3 cards:</p><div class="flex justify-around text-center"><div class="w-1/3 p-2 border border-gray-600 rounded-lg"><span class="block font-bold">1</span><span class="block text-sm text-indigo-300">Past</span></div><div class="w-1/3 p-2 border border-gray-600 rounded-lg mx-2"><span class="block font-bold">2</span><span class="block text-sm text-indigo-300">Present</span></div><div class="w-1/3 p-2 border border-gray-600 rounded-lg"><span class="block font-bold">3</span><span class="block text-sm text-indigo-300">Future</span></div></div>` },
            "celtic-cross": { id: "celtic-cross", name: "10-Card Celtic Cross", description: "A deep analysis.", card_count: 10, map: [{ position: 1, name: "Present", description: "Heart of the matter, current state." }, { position: 2, name: "Challenge", description: "Immediate obstacle or influence." }, { position: 3, name: "Foundation", description: "Root cause, past basis." }, { position: 4, name: "Recent Past", description: "Events just passing." }, { position: 5, name: "Potential", description: "Best outcome, conscious goals." }, { position: 6, name: "Near Future", description: "Immediate future events." }, { position: 7, name: "Self", description: "Your attitude or self-perception." }, { position: 8, name: "External", description: "Environmental or external influences." }, { position: 9, name: "Hopes/Fears", description: "Subconscious desires/anxieties." }, { position: 10, name: "Outcome", description: "Likely resolution." }], visual_guide: `<p class="text-sm text-gray-300 mb-4">Lay 10 cards:</p><div class="grid grid-cols-4 gap-2 text-center text-xs"><div></div> <div></div><div class="p-2 border border-gray-600 rounded-lg"><span class="block font-bold">10</span><span class="block text-indigo-300">Outcome</span></div><div class="p-2 border border-gray-600 rounded-lg"><span class="block font-bold">7</span><span class="block text-indigo-300">Self</span></div><div class="p-2 border border-gray-600 rounded-lg"><span class="block font-bold">5</span><span class="block text-indigo-300">Potential</span></div><div class="p-2 border border-gray-600 rounded-lg row-span-2 relative"><span class="block font-bold">1</span><span class="block text-indigo-300">Present</span><div class="absolute top-1/2 left-1/4 w-1/2 p-2 border-2 border-dashed border-indigo-400 rounded-lg" style="transform: translateY(-50%) rotate(90deg);"><span class="block font-bold">2</span><span class="block text-indigo-300">Challenge</span></div></div><div class="p-2 border border-gray-600 rounded-lg"><span class="block font-bold">9</span><span class="block text-indigo-300">Hopes/Fears</span></div><div class="p-2 border border-gray-600 rounded-lg"><span class="block font-bold">8</span><span class="block text-indigo-300">External</span></div><div class="p-2 border border-gray-600 rounded-lg"><span class="block font-bold">4</span><span class="block text-indigo-300">Recent Past</span></div><div></div> <div></div><div class="p-2 border border-gray-600 rounded-lg"><span class="block font-bold">6</span><span class="block text-indigo-300">Near Future</span></div><div></div><div class="p-2 border border-gray-600 rounded-lg"><span class="block font-bold">3</span><span class="block text-indigo-300">Foundation</span></div><div></div> <div></div></div>` }
        };

        // --- STATE MANAGEMENT ---
        const appState = { currentScreen: 'screen-intention', userIntention: '', selectedSpread: null, uploadedImage: null, reading: null };

        // --- DOM ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const imageUpload = document.getElementById('image-upload');
        const imageUploadText = document.getElementById('image-upload-text');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const revealButton = document.getElementById('btn-reveal');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');
        const resultsContent = document.getElementById('results-content');
        const summaryView = document.getElementById('summary-view');
        const summaryText = document.getElementById('summary-text');
        const deepDiveView = document.getElementById('deep-dive-view');
        const deepDiveCards = document.getElementById('deep-dive-cards');
        const deepDiveSpreadGuide = document.getElementById('deep-dive-spread-guide');
        const spreadLibraryContainer = document.getElementById('spread-library');
        const visualGuideContainer = document.getElementById('spread-visual-guide');
        const selectedSpreadName = document.getElementById('selected-spread-name');
        const btnToIntention = document.getElementById('btn-back-to-intention');
        const btnToSpread = document.getElementById('btn-to-spread');
        const btnToUpload = document.getElementById('btn-to-upload');
        const btnToSpreadBack = document.getElementById('btn-back-to-spread');
        const btnNewReading = document.getElementById('btn-new-reading');
        const toggleSummary = document.getElementById('toggle-summary');
        const toggleDeepDive = document.getElementById('toggle-deep-dive');
        const userIntentionOther = document.getElementById('user-intention-other');

        /** Core navigation function */
        function showScreen(screenId) {
            screens.forEach(screen => screen.style.display = 'none');
            const newScreen = document.getElementById(screenId);
            newScreen.style.display = 'block';
            appState.currentScreen = screenId;
            window.scrollTo(0, 0);
            const heading = newScreen.querySelector('h2');
            if (heading) { heading.setAttribute('tabindex', -1); heading.focus(); }
        }

        // --- JS-CONTROLLED ICON VISIBILITY ---
        function handleIntentionSelection(radioId) {
            const radio = document.getElementById(radioId);
            if (radio) {
                radio.checked = true; // Manually check the hidden radio

                // Hide all intention icons first
                document.querySelectorAll('#intention-options .selection-icon').forEach(icon => {
                    icon.style.display = 'none';
                });

                // Show the icon within the clicked label
                const label = radio.nextElementSibling;
                const icon = label.querySelector('.selection-icon');
                if (icon) {
                     icon.style.display = 'inline-block';
                }

                if (radio.value === 'other') {
                    userIntentionOther.classList.remove('hidden');
                    userIntentionOther.focus();
                } else {
                    userIntentionOther.classList.add('hidden');
                }
                btnToSpread.disabled = false;
                btnToSpread.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function handleSpreadSelection(radioId) {
             const radio = document.getElementById(radioId);
             if (radio) {
                 radio.checked = true; // Manually check hidden radio
                 appState.selectedSpread = SPREAD_LIBRARY[radio.value];

                 // Hide all spread icons first
                 document.querySelectorAll('#spread-library .selection-icon').forEach(icon => {
                     icon.style.display = 'none';
                 });

                 // Show the icon within the clicked label
                const label = radio.nextElementSibling;
                const icon = label.querySelector('.selection-icon');
                if (icon) {
                    icon.style.display = 'inline-block';
                }

                 btnToUpload.disabled = false;
                 btnToUpload.classList.remove('opacity-50', 'cursor-not-allowed');
             }
        }

        // --- NAVIGATION EVENT LISTENERS ---
        btnToSpread.addEventListener('click', () => {
            const selectedIntentionRadio = document.querySelector('input[name="intention"]:checked');
            if (!selectedIntentionRadio) { alert('Please select an intention.'); return; }
            if (selectedIntentionRadio.value === 'other') {
                const otherText = userIntentionOther.value.trim();
                if (otherText.length < 5) { alert('Please enter your specific question.'); return; }
                appState.userIntention = otherText;
            } else {
                appState.userIntention = selectedIntentionRadio.value;
            }
            populateSpreadLibrary();
            showScreen('screen-spread-choice');
        });

        function populateSpreadLibrary() {
            spreadLibraryContainer.innerHTML = '';
            Object.values(SPREAD_LIBRARY).forEach(spread => {
                const isChecked = appState.selectedSpread && appState.selectedSpread.id === spread.id;
                spreadLibraryContainer.innerHTML += `
                    <div class="relative">
                        <input type="radio" id="${spread.id}" name="spread" value="${spread.id}" class="sr-only" ${isChecked ? 'checked' : ''}>
                        <label for="${spread.id}" class="radio-label" onclick="handleSpreadSelection('${spread.id}')">
                            <svg class="selection-icon" width="12" height="12" style="${isChecked ? 'display: inline-block;' : 'display: none;'}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            <div class="label-text-container">
                                <span class="font-semibold text-lg">${spread.name}</span>
                                <span class="label-subtext">${spread.description}</span>
                            </div>
                        </label>
                    </div>`;
            });
            if (appState.selectedSpread) {
                 btnToUpload.disabled = false;
                 btnToUpload.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                 btnToUpload.disabled = true;
                 btnToUpload.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        btnToUpload.addEventListener('click', () => {
            if (!appState.selectedSpread) { alert('Please select a spread.'); return; }
            selectedSpreadName.textContent = appState.selectedSpread.name;
            visualGuideContainer.innerHTML = appState.selectedSpread.visual_guide;
            showScreen('screen-upload');
        });

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    const base64String = e.target.result.split(',')[1];
                     if (!base64String) { displayError("Could not process image."); appState.uploadedImage = null; revealButton.disabled = true; revealButton.classList.add('opacity-50', 'cursor-not-allowed'); return; }
                    appState.uploadedImage = base64String;
                    revealButton.disabled = false;
                    revealButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    imageUploadText.textContent = file.name;
                };
                 reader.onerror = () => { displayError("Could not read file."); appState.uploadedImage = null; revealButton.disabled = true; revealButton.classList.add('opacity-50', 'cursor-not-allowed'); };
                reader.readAsDataURL(file);
            } else {
                appState.uploadedImage = null; revealButton.disabled = true; revealButton.classList.add('opacity-50', 'cursor-not-allowed'); imagePreviewContainer.classList.add('hidden'); imageUploadText.textContent = "Click to select an image";
            }
        });

        btnToIntention.addEventListener('click', () => showScreen('screen-intention'));
        btnToSpreadBack.addEventListener('click', () => showScreen('screen-spread-choice'));
        btnNewReading.addEventListener('click', () => {
            appState.userIntention = ''; appState.selectedSpread = null; appState.uploadedImage = null; appState.reading = null;
            const checkedIntention = document.querySelector('input[name="intention"]:checked'); if (checkedIntention) checkedIntention.checked = false;
            document.querySelectorAll('#intention-options .selection-icon, #spread-library .selection-icon').forEach(icon => icon.style.display = 'none');
            userIntentionOther.value = ''; userIntentionOther.classList.add('hidden');
            btnToSpread.disabled = true; btnToSpread.classList.add('opacity-50', 'cursor-not-allowed');
            btnToUpload.disabled = true; btnToUpload.classList.add('opacity-50', 'cursor-not-allowed');
            imageUpload.value = null; imagePreview.src = '#'; imagePreviewContainer.classList.add('hidden'); imageUploadText.textContent = "Click to select an image";
            revealButton.disabled = true; revealButton.classList.add('opacity-50', 'cursor-not-allowed');
            resultsContent.classList.add('hidden'); errorDisplay.classList.add('hidden');
            summaryText.textContent = ''; deepDiveCards.innerHTML = ''; deepDiveSpreadGuide.innerHTML = '';
            toggleSummary.click(); showScreen('screen-intention');
        });

        toggleSummary.addEventListener('click', () => {
            summaryView.style.display = 'block'; deepDiveView.style.display = 'none';
            toggleSummary.setAttribute('aria-pressed', 'true'); toggleSummary.classList.add('bg-indigo-600', 'text-white'); toggleSummary.classList.remove('text-gray-300');
            toggleDeepDive.setAttribute('aria-pressed', 'false'); toggleDeepDive.classList.add('text-gray-300'); toggleDeepDive.classList.remove('bg-indigo-600', 'text-white');
        });
        toggleDeepDive.addEventListener('click', () => {
            summaryView.style.display = 'none'; deepDiveView.style.display = 'block';
            toggleDeepDive.setAttribute('aria-pressed', 'true'); toggleDeepDive.classList.add('bg-indigo-600', 'text-white'); toggleDeepDive.classList.remove('text-gray-300');
            toggleSummary.setAttribute('aria-pressed', 'false'); toggleSummary.classList.add('text-gray-300'); toggleSummary.classList.remove('bg-indigo-600', 'text-white');
        });

        revealButton.addEventListener('click', () => { if (!appState.uploadedImage) { displayError('Please upload an image first.'); return; } performReading(); });

        async function performReading() {
            showScreen('screen-reading'); loadingSpinner.style.display = 'block'; resultsContent.style.display = 'none'; errorDisplay.style.display = 'none';
            const userIntention = appState.userIntention; const spreadName = appState.selectedSpread ? appState.selectedSpread.name : 'Unknown';
            const spreadMapString = appState.selectedSpread ? appState.selectedSpread.map.map(p => `Pos ${p.position} (${p.name}): ${p.description || 'General influence.'}`).join('\n') : '';
            if (!appState.selectedSpread || !appState.selectedSpread.map) { displayError('Invalid spread.'); loadingSpinner.style.display = 'none'; return; }
            const prompt = `You are The Oracle, a wise and insightful Tarot reader. A user has provided an image of a tarot spread, a question, and the spread's structure. USER'S QUESTION/INTENTION: "${userIntention}" SPREAD: "${spreadName}" SPREAD MAP (Position Number, Name, Meaning/Focus):\n${spreadMapString}\nAnalyze the provided image. Identify exactly ${appState.selectedSpread.card_count} cards, their orientations (Upright, Reversed, or Sideways), and match them to their corresponding position in the SPREAD MAP. Synthesize ALL this information (question, spread map, cards) into a cohesive narrative reading. Respond ONLY with a valid JSON object: {"summary": "...", "deep_dive": [{"position_number": N, "position_name": "...", "card_name": "...", "orientation": "...", "meaning": "..."}, ...]}. "summary" is 1 insightful paragraph (3-5 sentences) directly answering "${userIntention}". "deep_dive" is an array, 1 object per position. "meaning" MUST be a detailed interpretation of that card in that specific position, synthesized with "${userIntention}". Interpret "Sideways" as "blocked/delayed energy" related to the card's meaning and "${userIntention}". Example deep_dive: [{"position_number": 1, "position_name": "Present", "card_name": "The Fool", "orientation": "Upright", "meaning": "Regarding your career question, this signifies a leap of faith..."}]`;
            try {
                 // --- REAL API CALL ---
                 const apiKey = "AIzaSyBP0p_ZMBYw-7a3wVc6naoLd8cPmT0rAb4";
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                 const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: appState.uploadedImage } }] }], generationConfig: { responseMimeType: "application/json" } };
                 const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 if (!response.ok) { throw new Error(`API Error: ${response.status} ${response.statusText}`); }
                 const result = await response.json();
                 if (!result.candidates?.[0]?.content?.parts?.[0]?.text) { throw new Error("Malformed API response."); }
                 const jsonString = result.candidates[0].content.parts[0].text;
                 try {
                     const reading = JSON.parse(jsonString);
                     if (!reading.summary || !reading.deep_dive || !Array.isArray(reading.deep_dive)) { throw new Error("Incomplete JSON."); }
                     appState.reading = reading;
                     displayReading();
                 } catch (parseError) { throw new Error(`Unclear response: ${parseError.message}`); }
             } catch (error) { console.error('Error in performReading:', error); displayError(`Vision clouded: ${error.message}. Try again.`);
             } finally { loadingSpinner.style.display = 'none'; }
        }

        function displayReading() {
            if (!appState.reading) { displayError("Unknown error: No reading."); return; }
            try {
                summaryText.textContent = appState.reading.summary;
                deepDiveSpreadGuide.innerHTML = appState.selectedSpread.visual_guide;
                deepDiveCards.innerHTML = '';
                const currentSpreadMap = SPREAD_LIBRARY[appState.selectedSpread.id]?.map || [];
                appState.reading.deep_dive.forEach(card => {
                    const positionInfo = currentSpreadMap.find(p => p.position === card.position_number);
                    const positionName = positionInfo?.name || card.position_name || 'Unknown Position';
                    const positionDescription = positionInfo?.description || '';

                    deepDiveCards.innerHTML += `
                    <div class="p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                        <div class="flex items-start mb-2">
                            <span class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full bg-indigo-600 text-white font-bold text-sm mr-3 mt-1">${card.position_number}</span>
                            <div>
                                <h4 class="text-lg font-semibold text-white">${card.card_name} (${card.orientation})</h4>
                                <p class="text-sm font-medium text-indigo-300">${positionName}</p>
                                ${positionDescription ? `<p class="text-xs text-gray-400 italic mt-0.5">${positionDescription}</p>` : ''}
                            </div>
                        </div>
                        <p class="text-gray-300 ml-11">${card.meaning}</p>
                    </div>`;
                });
                resultsContent.style.display = 'block'; errorDisplay.style.display = 'none';
                toggleSummary.click(); // Default to summary
            } catch (error) { console.error('Error displayReading:', error); displayError(`Error displaying: ${error.message}`); }
        }

        function displayError(message) {
            errorMessage.textContent = message; errorDisplay.style.display = 'block'; resultsContent.style.display = 'none'; loadingSpinner.style.display = 'none';
        }

        // DOMContentLoaded listener for initial icon hide
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM Loaded, hiding icons...");
             document.querySelectorAll('.selection-icon').forEach(icon => {
                 const label = icon.closest('label');
                 const inputId = label ? label.getAttribute('for') : null;
                 const input = inputId ? document.getElementById(inputId) : null;
                 if (!input || !input.checked) {
                    icon.style.display = 'none';
                 } else {
                     icon.style.display = 'inline-block';
                 }
             });
        });
    </script>
</body>
</html>

