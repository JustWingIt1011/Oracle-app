<!-- Version 1.0 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Oracle's Eye - Walk Phase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark gray-blue */
            padding-bottom: 4rem;
        }
        .screen {
            display: none; /* All screens hidden by default */
        }
        #screen-intention {
            display: block; /* Show the first screen */
        }
        .btn {
            @apply inline-block w-full text-center px-6 py-3 rounded-lg font-semibold text-white shadow-md transition-all duration-300;
            @apply focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800;
        }
        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-500;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-500;
        }
        /* Style for disabled primary button */
        .btn-primary:disabled {
            @apply bg-indigo-800 opacity-50 cursor-not-allowed;
        }
        .card-bg {
            @apply bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-xl;
        }
        .input-base {
             @apply w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500;
        }
        textarea.input-base {
            resize: none;
        }
        /* Updated Radio Button Style (Pill/Segmented) */
        .radio-label {
            @apply block w-full p-4 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer text-center transition-colors duration-200 hover:bg-gray-600 focus-within:ring-2 focus-within:ring-indigo-500;
        }
        /* This is the key: when the hidden radio is checked, style its sibling label */
        input[type="radio"]:checked + .radio-label {
            @apply bg-indigo-700 border-indigo-500 text-white ring-2 ring-indigo-500;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto max-w-lg p-4 min-h-screen flex flex-col justify-center">

        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-white mb-2">The Oracle's Eye</h1>
            <p class="text-lg text-indigo-300">A Guided Tarot Experience</p>
        </header>

        <main class="card-bg" role="main">

            <!-- SCREEN 1: INTENTION -->
            <div id="screen-intention" class="screen" role="region" aria-label="Step 1: Set Intention">
                <h2 class="text-2xl font-semibold text-white mb-4" tabindex="-1">What is your intention?</h2>
                <p class="text-gray-300 mb-4">Select the area of your life that needs clarity. This will focus the reading.</p>

                <!-- V1.0: Converted to fieldset -->
                <fieldset id="intention-options" class="space-y-3">
                    <legend class="sr-only">Intention Options</legend>
                    <div class="relative">
                        <input type="radio" id="intent-general" name="intention" value="General Guidance & Self-Discovery" class="sr-only">
                        <label for="intent-general" class="radio-label">
                            <span class="font-semibold">General Guidance</span>
                            <span class="block text-sm text-gray-300">"What do I need to know right now?"</span>
                        </label>
                    </div>
                    <div class="relative">
                        <input type="radio" id="intent-problem" name="intention" value="Problem Solving & Career" class="sr-only">
                        <label for="intent-problem" class="radio-label">
                            <span class="font-semibold">Problem Solving & Career</span>
                            <span class="block text-sm text-gray-300">"How can I overcome this challenge?"</span>
                        </label>
                    </div>
                    <div class="relative">
                        <input type="radio" id="intent-relationships" name="intention" value="Relationships & Connection" class="sr-only">
                        <label for="intent-relationships" class="radio-label">
                            <span class="font-semibold">Relationships & Connection</span>
                            <span class="block text-sm text-gray-300">"What do I need to understand about this relationship?"</span>
                        </label>
                    </div>
                    <div class="relative">
                        <input type="radio" id="intent-other" name="intention" value="other" class="sr-only">
                        <label for="intent-other" class="radio-label">
                            <span class="font-semibold">Other (Specify)</span>
                        </label>
                    </div>
                </fieldset>

                <textarea id="user-intention-other" rows="3" placeholder="Type your specific question here..." class="input-base mt-3 hidden"></textarea>

                <!-- V1.0: Button now disabled by default -->
                <button id="btn-to-spread" class="btn btn-primary mt-4" disabled>Set Intention & Choose Spread</button>
            </div>

            <!-- SCREEN 2: SPREAD CHOICE -->
            <div id="screen-spread-choice" class="screen" role="region" aria-label="Step 2: Choose Spread">
                <h2 class="text-2xl font-semibold text-white mb-4" tabindex="-1">Choose Your Spread</h2>
                <p class="text-gray-300 mb-4">The spread provides the structure for your reading. Select one that fits your question.</p>

                <!-- V1.0: Converted to fieldset -->
                <fieldset id="spread-library" class="space-y-3">
                    <legend class="sr-only">Spread Options</legend>
                    <!-- This will be dynamically populated by SPREAD_LIBRARY -->
                </fieldset>

                <!-- V1.0: Button now disabled by default -->
                <button id="btn-to-upload" class="btn btn-primary mt-4" disabled>Continue to Upload</button>
                <button id="btn-back-to-intention" class="btn btn-secondary mt-2">Back</button>
            </div>

            <!-- SCREEN 3: UPLOAD & GUIDE -->
            <div id="screen-upload" class="screen" role="region" aria-label="Step 3: Upload Photo">
                <h2 class="text-2xl font-semibold text-white mb-2" tabindex="-1">Lay Out Your Cards</h2>
                <p class="text-gray-300 mb-4">Arrange your physical cards according to the <span id="selected-spread-name" class="font-semibold text-indigo-300">Selected Spread</span>, then upload a single photo.</p>

                <div id="spread-visual-guide" class="mb-6 p-4 bg-gray-700 rounded-lg">
                    <!-- DYNAMIC CONTENT GOES HERE -->
                </div>

                <div class="mb-4">
                    <label for="image-upload" class="block w-full p-6 border-2 border-dashed border-gray-600 rounded-lg text-center cursor-pointer hover:border-indigo-500 hover:bg-gray-700 transition-all focus-within:ring-2 focus-within:ring-indigo-500">
                        <span id="image-upload-text" class="text-gray-300">Click to select an image</span>
                        <input type="file" id="image-upload" class="hidden" accept="image/*">
                    </label>
                </div>

                <div id="image-preview-container" class="mb-4 hidden">
                    <img id="image-preview" src="#" alt="Your uploaded spread" class="max-h-60 w-auto mx-auto rounded-lg shadow-md">
                </div>

                <details class="mb-4">
                    <summary class="text-sm text-gray-500 cursor-pointer hover:text-white focus:outline-none focus:ring-1 focus:ring-indigo-500">Pro Tips for a Good Reading</summary>
                    <ul class="list-disc list-inside text-sm text-gray-300 mt-2 pl-2">
                        <li>Ensure good, even lighting.</li>
                        <li>Avoid shadows or glare on the cards.</li>
                        <li>Keep the camera parallel to the table.</li>
                        <li>Make sure all cards are fully visible.</li>
                    </ul>
                </details>

                <!-- V1.0: Button now disabled by default -->
                <button id="btn-reveal" class="btn btn-primary mt-6" disabled>Reveal My Reading</button>
                <button id="btn-back-to-spread" class="btn btn-secondary mt-2">Back</button>
            </div>

            <!-- SCREEN 4: READING -->
            <div id="screen-reading" class="screen" role="region" aria-label="Step 4: Your Reading">
                <h2 class="text-2xl font-semibold text-white mb-4" tabindex="-1">Your Reading</h2>

                <div class="mb-4 flex justify-center" role="group" aria-label="Reading Format">
                    <div class="bg-gray-700 p-1 rounded-lg flex space-x-1">
                        <button id="toggle-summary" class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-pressed="true">Summary</button>
                        <button id="toggle-deep-dive" class="px-4 py-2 text-sm font-semibold text-gray-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-pressed="false">In-Depth</button>
                    </div>
                </div>

                <div id="loading-spinner" class="text-center py-10 hidden" role="status" aria-live="polite">
                    <svg class="animate-spin h-8 w-8 text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-300 mt-3">The Oracle is considering your question...</p>
                </div>

                <div id="error-display" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4" role="alert" aria-live="assertive">
                    <strong class="font-bold">A murky vision!</strong>
                    <span id="error-message" class="block sm:inline"></span>
                </div>

                <div id="results-content" class="hidden" aria-live="polite">
                    <!-- Summary View -->
                    <div id="summary-view" class="">
                        <h3 class="text-xl font-semibold text-indigo-300 mb-2">Your Summary</h3>
                        <p id="summary-text" class="text-gray-300 text-lg leading-relaxed">[Summary of the entire reading will appear here...]</p>
                    </div>
                    <!-- In-Depth View -->
                    <div id="deep-dive-view" class="hidden space-y-4">
                        <h3 class="text-xl font-semibold text-indigo-300 mb-2">Spread Context</h3>
                        <div id="deep-dive-spread-guide" class="mb-6 p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                           <!-- DYNAMIC CONTENT GOES HERE -->
                        </div>
                        <h3 class="text-xl font-semibold text-indigo-300 mb-2">Card-by-Card Deep Dive</h3>
                        <div id="deep-dive-cards" class="space-y-4">
                            <!-- DYNAMIC CONTENT GOES HERE -->
                        </div>
                    </div>
                </div>

                <button id="btn-new-reading" class="btn btn-secondary mt-6">Start New Reading</button>
            </div>

        </main>

        <footer class="text-center text-xs text-gray-500 mt-4">
            Version 1.0
        </footer>
    </div>

    <script>
        // --- SPREAD LIBRARY (From Your Research!) ---
        const SPREAD_LIBRARY = {
            "three-card": {
                id: "three-card",
                name: "Three-Card Spread",
                description: "A quick, versatile spread for clarity on a situation.",
                card_count: 3,
                map: [
                    { position: 1, name: "Past", description: "Past events and influences that led to this situation." },
                    { position: 2, name: "Present", description: "The current situation and energies at play." },
                    { position: 3, name: "Future", description: "The likely outcome if the current path continues." }
                ],
                visual_guide: `
                    <p class="text-sm text-gray-300 mb-4">Lay your 3 cards in a horizontal line:</p>
                    <div class="flex justify-around text-center">
                        <div class="w-1/3 p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">1</span>
                            <span class="block text-sm text-indigo-300">Past</span>
                        </div>
                        <div class="w-1/3 p-2 border border-gray-600 rounded-lg mx-2">
                            <span class="block font-bold text-white">2</span>
                            <span class="block text-sm text-indigo-300">Present</span>
                        </div>
                        <div class="w-1/3 p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">3</span>
                            <span class="block text-sm text-indigo-300">Future</span>
                        </div>
                    </div>
                `
            },
            "celtic-cross": {
                id: "celtic-cross",
                name: "10-Card Celtic Cross",
                description: "A deep, comprehensive analysis of a complex situation.",
                card_count: 10,
                map: [
                    { position: 1, name: "The Present / The Self", description: "The heart of the matter; your current state of mind." },
                    { position: 2, name: "The Challenge", description: "The immediate obstacle or supporting influence." },
                    { position: 3, name: "The Foundation / The Past", description: "The root cause or past events forming the foundation." },
                    { position: 4, name: "The Recent Past", description: "Events that are just passing or energies that linger." },
                    { position: 5, name: "The Potential / The Crown", description: "The best possible outcome or conscious goals." },
                    { position: 6, name: "The Near Future", description: "What is likely to happen in the immediate future." },
                    { position: 7, name: "Your Influence / The Self", description: "Your attitude or self-perception in this matter." },
                    { position: 8, name: "External Influences", description: "The people, places, or external energies affecting you." },
                    { position: 9, name: "Hopes and Fears", description: "Your subconscious desires and anxieties." },
                    { position: 10, name: "The Outcome", description: "The likely resolution if the current path is followed." }
                ],
                visual_guide: `
                    <p class="text-sm text-gray-300 mb-4">Lay your 10 cards in the Celtic Cross pattern:</p>
                    <div class="grid grid-cols-4 gap-2 text-center text-xs">
                        <!-- Staff (Right Side) -->
                        <div></div> <div></div>
                        <div class ="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">10</span>
                            <span class="block text-indigo-300">Outcome</span>
                        </div>
                        <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">7</span>
                            <span class="block text-indigo-300">Self</span>
                        </div>

                        <div class="p-2 border border-gray-600 rounded-lg">
                            <span class ="block font-bold text-white">5</span>
                            <span class="block text-indigo-300">Potential</span>
                        </div>
                        <div class="p-2 border border-gray-600 rounded-lg row-span-2 relative">
                            <span class="block font-bold text-white">1</span>
                            <span class="block text-indigo-300">Present</span>
                            <div class="absolute top-1/2 left-1/4 w-1/2 p-2 border-2 border-dashed border-indigo-400 rounded-lg" style="transform: translateY(-50%) rotate(90deg);">
                                <span class="block font-bold text-white">2</span>
                                <span class="block text-indigo-300">Challenge</span>
                            </div>
                        </div>
                         <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">9</span>
                            <span class="block text-indigo-300">Hopes/Fears</span>
                        </div>
                         <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">8</span>
                            <span class="block text-indigo-300">External</span>
                        </div>

                        <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">4</span>
                            <span class="block text-indigo-300">Recent Past</span>
                        </div>
                         <div></div> <div></div>
                         <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">6</span>
                            <span class="block text-indigo-300">Near Future</span>
                        </div>

                         <div></div>
                        <div class="p-2 border border-gray-600 rounded-lg">
                            <span class="block font-bold text-white">3</span>
                            <span class="block text-indigo-300">Foundation</span>
                        </div>
                        <div></div> <div></div>
                    </div>
                `
            }
        };

        // --- STATE MANAGEMENT ---
        const appState = {
            currentScreen: 'screen-intention',
            userIntention: '',
            selectedSpread: null,
            uploadedImage: null,
            reading: null
        };

        // --- DOM ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const imageUpload = document.getElementById('image-upload');
        const imageUploadText = document.getElementById('image-upload-text');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const revealButton = document.getElementById('btn-reveal');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');
        const resultsContent = document.getElementById('results-content');
        const summaryView = document.getElementById('summary-view');
        const summaryText = document.getElementById('summary-text');
        const deepDiveView = document.getElementById('deep-dive-view');
        const deepDiveCards = document.getElementById('deep-dive-cards');
        const deepDiveSpreadGuide = document.getElementById('deep-dive-spread-guide');
        const spreadLibraryContainer = document.getElementById('spread-library');
        const visualGuideContainer = document.getElementById('spread-visual-guide');
        const selectedSpreadName = document.getElementById('selected-spread-name');

        // --- NAVIGATION BUTTONS ---
        const btnToIntention = document.getElementById('btn-back-to-intention');
        const btnToSpread = document.getElementById('btn-to-spread');
        const btnToUpload = document.getElementById('btn-to-upload');
        const btnToSpreadBack = document.getElementById('btn-back-to-spread');
        const btnNewReading = document.getElementById('btn-new-reading');
        const toggleSummary = document.getElementById('toggle-summary');
        const toggleDeepDive = document.getElementById('toggle-deep-dive');

        // --- FIELDSETS & INPUTS ---
        const intentionOptions = document.getElementById('intention-options');
        const userIntentionOther = document.getElementById('user-intention-other');
        const spreadLibrary = document.getElementById('spread-library');

        /**
         * Core navigation function.
         */
        function showScreen(screenId) {
            screens.forEach(screen => screen.style.display = 'none');
            const newScreen = document.getElementById(screenId);
            newScreen.style.display = 'block';
            appState.currentScreen = screenId;
            window.scrollTo(0, 0);

            const heading = newScreen.querySelector('h2');
            if(heading) {
                heading.setAttribute('tabindex', -1);
                heading.focus();
            }
        }
        
        // --- V1.0: SIMPLIFIED EVENT LISTENERS ---

        // --- INTENTION SCREEN ---
        // Listen for changes on the whole fieldset
        intentionOptions.addEventListener('change', (e) => {
            const radio = e.target;
            if (radio.name === 'intention') {
                if (radio.value === 'other') {
                    userIntentionOther.classList.remove('hidden');
                    userIntentionOther.focus();
                } else {
                    userIntentionOther.classList.add('hidden');
                }
                // Enable the continue button
                btnToSpread.disabled = false;
                btnToSpread.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // Screen 1 -> Screen 2
        btnToSpread.addEventListener('click', () => {
            const selectedIntention = document.querySelector('input[name="intention"]:checked');
            // This check is now *almost* redundant, but good for safety
            if (!selectedIntention) {
                alert('Please select an intention to proceed.');
                return;
            }

            if (selectedIntention.value === 'other') {
                const otherText = userIntentionOther.value.trim();
                if (otherText.length < 5) {
                    alert('Please enter your specific question.');
                    return;
                }
                appState.userIntention = otherText;
            } else {
                appState.userIntention = selectedIntention.value;
            }

            populateSpreadLibrary();
            showScreen('screen-spread-choice');
        });

        // --- SPREAD SCREEN ---
        function populateSpreadLibrary() {
            spreadLibraryContainer.innerHTML = ''; // Clear old
            Object.values(SPREAD_LIBRARY).forEach(spread => {
                // Check if this spread was the one previously selected
                const isChecked = appState.selectedSpread && appState.selectedSpread.id === spread.id;
                const spreadHtml = `
                    <div class="relative">
                        <input type="radio" id="${spread.id}" name="spread" value="${spread.id}" class="sr-only" ${isChecked ? 'checked' : ''}>
                        <label for="${spread.id}" class="radio-label">
                            <span class="font-semibold text-lg">${spread.name}</span>
                            <span class="block text-sm text-gray-300">${spread.description}</span>
                        </label>
                    </div>
                `;
                spreadLibraryContainer.innerHTML += spreadHtml;
            });
            
            // If a spread was already checked, ensure the button is enabled
            if (appState.selectedSpread) {
                 btnToUpload.disabled = false;
                 btnToUpload.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                 btnToUpload.disabled = true;
                 btnToUpload.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // Listen for changes on the spread library fieldset
        spreadLibrary.addEventListener('change', (e) => {
            const radio = e.target;
            if (radio.name === 'spread') {
                appState.selectedSpread = SPREAD_LIBRARY[radio.value];
                // Enable the continue button
                btnToUpload.disabled = false;
                btnToUpload.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
        
        // Screen 2 -> Screen 3
        btnToUpload.addEventListener('click', () => {
            if (!appState.selectedSpread) {
                alert('Please select a spread.');
                return;
            }
            selectedSpreadName.textContent = appState.selectedSpread.name;
            visualGuideContainer.innerHTML = appState.selectedSpread.visual_guide;
            showScreen('screen-upload');
        });
        
        // --- UPLOAD SCREEN ---
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    const base64String = e.target.result.split(',')[1];
                     if (!base64String) {
                         console.error("Failed to extract base64 data from image.");
                         displayError("Could not process the selected image. Please try a different one.");
                         appState.uploadedImage = null;
                         revealButton.disabled = true;
                         revealButton.classList.add('opacity-50', 'cursor-not-allowed');
                         return;
                     }
                    appState.uploadedImage = base64String;
                    revealButton.disabled = false;
                    revealButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    imageUploadText.textContent = file.name;
                };
                 reader.onerror = (error) => {
                     console.error("FileReader error:", error);
                     displayError("Could not read the selected image file. Please try again.");
                     appState.uploadedImage = null;
                     revealButton.disabled = true;
                     revealButton.classList.add('opacity-50', 'cursor-not-allowed');
                 };
                reader.readAsDataURL(file);
            } else {
                appState.uploadedImage = null;
                revealButton.disabled = true;
                revealButton.classList.add('opacity-50', 'cursor-not-allowed');
                imagePreviewContainer.classList.add('hidden');
                imageUploadText.textContent = "Click to select an image";
            }
        });
        
        // --- NAVIGATION (BACK & NEW) ---
        
        // Screen 2 -> Screen 1 (Back)
        btnToIntention.addEventListener('click', () => showScreen('screen-intention'));
        
        // Screen 3 -> Screen 2 (Back)
        btnToSpreadBack.addEventListener('click', () => showScreen('screen-spread-choice'));

        // Screen 4 -> Screen 1 (New Reading)
        btnNewReading.addEventListener('click', () => {
            // Reset state
            appState.userIntention = '';
            appState.selectedSpread = null;
            appState.uploadedImage = null;
            appState.reading = null;

            // Reset Intention Screen
            const checkedIntention = document.querySelector('input[name="intention"]:checked');
            if (checkedIntention) checkedIntention.checked = false;
            userIntentionOther.value = '';
            userIntentionOther.classList.add('hidden');
            btnToSpread.disabled = true; // V1.0 Reset to disabled
            btnToSpread.classList.add('opacity-50', 'cursor-not-allowed');

            // Reset Spread Screen
            btnToUpload.disabled = true; // V1.0 Reset to disabled
            btnToUpload.classList.add('opacity-50', 'cursor-not-allowed');
            // We'll repopulate spreads when screen is shown, so no need to uncheck here

            // Reset Upload Screen
            imageUpload.value = null;
            imagePreview.src = '#';
            imagePreviewContainer.classList.add('hidden');
            imageUploadText.textContent = "Click to select an image";
            revealButton.disabled = true; // V1.0 Reset to disabled
            revealButton.classList.add('opacity-50', 'cursor-not-allowed');

            // Reset Reading Screen
            resultsContent.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            summaryText.textContent = '';
            deepDiveCards.innerHTML = '';
            deepDiveSpreadGuide.innerHTML = '';
            toggleSummary.click(); // Programmatically click summary

            showScreen('screen-intention');
        });

        // --- READING TOGGLE ---
        toggleSummary.addEventListener('click', () => {
            summaryView.style.display = 'block';
            deepDiveView.style.display = 'none';
            toggleSummary.setAttribute('aria-pressed', 'true');
            toggleSummary.classList.add('bg-indigo-600', 'text-white');
            toggleSummary.classList.remove('text-gray-300');
            toggleDeepDive.setAttribute('aria-pressed', 'false');
            toggleDeepDive.classList.add('text-gray-300');
            toggleDeepDive.classList.remove('bg-indigo-600', 'text-white');
        });

        toggleDeepDive.addEventListener('click', () => {
            summaryView.style.display = 'none';
            deepDiveView.style.display = 'block';
            toggleDeepDive.setAttribute('aria-pressed', 'true');
            toggleDeepDive.classList.add('bg-indigo-600', 'text-white');
            toggleDeepDive.classList.remove('text-gray-300');
            toggleSummary.setAttribute('aria-pressed', 'false');
            toggleSummary.classList.add('text-gray-300');
            toggleSummary.classList.remove('bg-indigo-600', 'text-white');
        });

        // --- AI API CALL ---
        revealButton.addEventListener('click', () => {
            if (!appState.uploadedImage) {
                displayError('Please upload an image first.');
                return;
            }
            performReading();
        });

        async function performReading() {
            console.log("Starting performReading...");
            showScreen('screen-reading');
            loadingSpinner.style.display = 'block';
            resultsContent.style.display = 'none';
            errorDisplay.style.display = 'none';

            const userIntention = appState.userIntention;
            const spreadName = appState.selectedSpread ? appState.selectedSpread.name : 'Unknown Spread';
            const spreadMapString = appState.selectedSpread ? appState.selectedSpread.map
                .map(p => `Position ${p.position} (${p.name}): ${p.description}`)
                .join('\n') : 'No spread map available.';

             if (!appState.selectedSpread || !appState.selectedSpread.map || !Array.isArray(appState.selectedSpread.map)) {
                 console.error("performReading Error: appState.selectedSpread is invalid", appState.selectedSpread);
                 displayError('Error: Invalid spread selected. Please go back and choose a spread.');
                 loadingSpinner.style.display = 'none';
                 return;
             }

            const prompt = `
                You are The Oracle, a wise and insightful Tarot reader.
                A user has provided an image of a tarot spread, a question, and the spread's structure.

                USER'S QUESTION/INTENTION: "${userIntention}"
                SPREAD: "${spreadName}"
                SPREAD MAP:
                ${spreadMapString}

                Analyze the provided image of their tarot spread.
                Your task is to identify exactly ${appState.selectedSpread.card_count} cards, their orientations (Upright, Reversed, or Sideways), and their positions in the spread.
                Match the card's physical position in the image to its corresponding position in the SPREAD MAP.

                Synthesize ALL this information (the question, the spread map, and the cards) into a cohesive, narrative reading.

                Respond ONLY with a valid JSON object with two keys: "summary" and "deep_dive".

                1.  "summary": A single, insightful paragraph (3-5 sentences) that provides the main message of the reading, directly answering the user's question about their intention ("${userIntention}"). Ensure the summary reflects the specific intention.
                2.  "deep_dive": An array of objects, one for each position in the spread. Each object must have "position_number", "position_name", "card_name", "orientation", and "meaning".

                "meaning" MUST be a detailed interpretation of that specific card in that specific position, synthesized with the user's question ("${userIntention}").

                If you detect a card is "Sideways", interpret it as "blocked or delayed energy" related to that card's meaning in the context of the user's question ("${userIntention}").

                Example for deep_dive array if the question was about career:
                [
                    { "position_number": 1, "position_name": "The Present / The Self", "card_name": "The Fool", "orientation": "Upright", "meaning": "In the context of your career question, this represents a new beginning. You are at the start of a new professional journey..." },
                    { "position_number": 2, "position_name": "The Challenge", "card_name": "The Tower", "orientation": "Reversed", "meaning": "Regarding your career challenge, your main obstacle is an avoidance of a necessary change. You are resisting a "Tower" moment..." }
                ]
            `;

            try {
                // --- SIMULATED RESPONSE (FOR OFFLINE DEVELOPMENT) ---
                /* // This block is commented out to enable the real API call
                console.log("Simulating API call...");
                await new Promise(resolve => setTimeout(resolve, 2000)); 

                 if (!appState.selectedSpread || !appState.selectedSpread.map || !Array.isArray(appState.selectedSpread.map)) {
                     throw new Error("Cannot generate simulation: selectedSpread.map is invalid.");
                 }
                const simulatedSummary = `Simulated summary specifically addressing your intention about "${appState.userIntention}". This reading highlights key energies related to your question, suggesting a focus on [Simulated Theme 1, e.g., 'new opportunities'] and navigating [Simulated Theme 2, e.g., 'unexpected challenges']. The overall outlook leans towards [Simulated Tone, e.g., 'cautious optimism'].`;
                const simulatedResponse = {
                    summary: simulatedSummary,
                    deep_dive: appState.selectedSpread.map.map((position, index) => {
                        const cards = ["The Fool", "The Tower", "The High Priestess", "The Magician", "The Lovers", "The Chariot", "Strength", "The Hermit", "Wheel of Fortune", "Justice"];
                        const orientations = ["Upright", "Reversed", "Sideways"];
                        const card = cards[index % cards.length];
                        const orientation = orientations[index % orientations.length];
                        const simulatedMeaning = `This is a simulated interpretation for ${card} (${orientation}) in the '${position.name || 'Unknown Position'}' position, specifically relating to your intention about "${appState.userIntention}". It represents how the card's energy might manifest in this context.`;
                        return {
                            position_number: position.position,
                            position_name: position.name || "Unknown Position",
                            card_name: card,
                            orientation: orientation,
                            meaning: simulatedMeaning
                        };
                    })
                };
                console.log("Simulation complete. Generated response:", simulatedResponse);
                appState.reading = simulatedResponse;
                displayReading();

            } catch (simError) {
                 console.error('Error during simulation generation or displayReading call:', simError);
                 displayError(`An unexpected error occurred during the simulation: ${simError.message}`);
            } finally {
                 console.log("Hiding spinner in finally block.");
                 loadingSpinner.style.display = 'none';
            }
            */ // End of commented-out simulation block


            // --- REAL API CALL (NOW ENABLED) ---
            try {
                console.log("Attempting REAL API call...");
                const apiKey = "AIzaSyBP0p_ZMBYw-7a3wVc6naoLd8cPmT0rAb4"; // Your API Key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: appState.uploadedImage } }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };
                console.log("Sending payload to API...");

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log("API response status:", response.status);

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response Body:", errorBody);
                    throw new Error(`API Error: ${response.status} ${response.statusText}.`);
                }

                const result = await response.json();
                console.log("API Result:", result);

                if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0] || !result.candidates[0].content.parts[0].text) {
                     console.error("Malformed API response structure:", result);
This model's content is truncated.

